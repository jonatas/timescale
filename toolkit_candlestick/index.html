
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.7">
    
    
      
        <title>Toolkit Candlesticks tutorial - The Timescaledb gem</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-9B2BMB0TNQ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-9B2BMB0TNQ",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-9B2BMB0TNQ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#candlesticks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The Timescaledb gem" class="md-header__button md-logo" aria-label="The Timescaledb gem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Timescaledb gem
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Toolkit Candlesticks tutorial
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jonatas/timescaledb" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The Timescaledb gem" class="md-nav__button md-logo" aria-label="The Timescaledb gem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    The Timescaledb gem
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jonatas/timescaledb" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../migrations/" class="md-nav__link">
        Migrations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        Models
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../toolkit/" class="md-nav__link">
        Toolkit Integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../toolkit_lttb_tutorial/" class="md-nav__link">
        Toolkit LTTB Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../toolkit_lttb_zoom/" class="md-nav__link">
        Zooming with High Resolution
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Toolkit Candlesticks tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Toolkit Candlesticks tutorial
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storing-your-market-data" class="md-nav__link">
    Storing your market data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-hypertable" class="md-nav__link">
    Create the hypertable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-orm-model" class="md-nav__link">
    Create the ORM model
  </a>
  
    <nav class="md-nav" aria-label="Create the ORM model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-acts_as_hypertable-macro" class="md-nav__link">
    The acts_as_hypertable macro
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-acts_as_time_vector-macro" class="md-nav__link">
    The acts_as_time_vector macro
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inserting-data" class="md-nav__link">
    Inserting data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-data" class="md-nav__link">
    Query data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-aggregates" class="md-nav__link">
    Continuous aggregates
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models-for-views" class="md-nav__link">
    Models for views
  </a>
  
    <nav class="md-nav" aria-label="Models for views">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-candlestick-concern" class="md-nav__link">
    The candlestick concern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical-continuous-aggregates" class="md-nav__link">
    Hierarchical continuous aggregates
  </a>
  
    <nav class="md-nav" aria-label="Hierarchical continuous aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollup" class="md-nav__link">
    Rollup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-policy" class="md-nav__link">
    Refresh policy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-continuous-aggregates-with-custom-activerecord-models" class="md-nav__link">
    Querying Continuous Aggregates with custom ActiveRecord models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plotting-data" class="md-nav__link">
    Plotting data
  </a>
  
    <nav class="md-nav" aria-label="Plotting data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-sinatra-app" class="md-nav__link">
    The Sinatra App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-data-with-javascript" class="md-nav__link">
    Plotting data with Javascript
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-time-vectors" class="md-nav__link">
    Formatting time vectors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feedback-or-questions" class="md-nav__link">
    Feedback or questions?
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../command_line/" class="md-nav__link">
        Command Line
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../videos/" class="md-nav__link">
        Videos
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storing-your-market-data" class="md-nav__link">
    Storing your market data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-hypertable" class="md-nav__link">
    Create the hypertable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-orm-model" class="md-nav__link">
    Create the ORM model
  </a>
  
    <nav class="md-nav" aria-label="Create the ORM model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-acts_as_hypertable-macro" class="md-nav__link">
    The acts_as_hypertable macro
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-acts_as_time_vector-macro" class="md-nav__link">
    The acts_as_time_vector macro
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inserting-data" class="md-nav__link">
    Inserting data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-data" class="md-nav__link">
    Query data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-aggregates" class="md-nav__link">
    Continuous aggregates
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models-for-views" class="md-nav__link">
    Models for views
  </a>
  
    <nav class="md-nav" aria-label="Models for views">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-candlestick-concern" class="md-nav__link">
    The candlestick concern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical-continuous-aggregates" class="md-nav__link">
    Hierarchical continuous aggregates
  </a>
  
    <nav class="md-nav" aria-label="Hierarchical continuous aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollup" class="md-nav__link">
    Rollup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-policy" class="md-nav__link">
    Refresh policy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-continuous-aggregates-with-custom-activerecord-models" class="md-nav__link">
    Querying Continuous Aggregates with custom ActiveRecord models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plotting-data" class="md-nav__link">
    Plotting data
  </a>
  
    <nav class="md-nav" aria-label="Plotting data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-sinatra-app" class="md-nav__link">
    The Sinatra App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-data-with-javascript" class="md-nav__link">
    Plotting data with Javascript
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-time-vectors" class="md-nav__link">
    Formatting time vectors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feedback-or-questions" class="md-nav__link">
    Feedback or questions?
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/jonatas/timescaledb/edit/master/docs/toolkit_candlestick.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="candlesticks">Candlesticks<a class="headerlink" href="#candlesticks" title="Permanent link">&para;</a></h1>
<p>Candlesticks are a popular tool in technical analysis, used by traders to determine potential market movements.</p>
<p>The <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/install-timescaledb-toolkit/">toolkit</a> also allows you to compute candlesticks with the <a href="https://docs.timescale.com/api/latest/hyperfunctions/financial-analysis/candlestick/">candlestick</a> function.</p>
<p>Candlesticks are a type of price chart that displays the high, low, open, and close prices of a security for a specific period. They can be useful because they can provide information about market trends and reversals. For example, if you see that the stock has been trading in a range for a while, it may be worth considering buying or selling when the price moves outside of this range. Additionally, candlesticks can be used in conjunction with other technical indicators to make trading decisions.</p>
<p>Let's start defining a table that stores the trades from financial market data
and then we can calculate the candlesticks with the Timescaledb Toolkit.</p>
<h2 id="storing-your-market-data">Storing your market data<a class="headerlink" href="#storing-your-market-data" title="Permanent link">&para;</a></h2>
<p>Market data is generally a massive data events stream. You can watch multiple
stock transactions globabally and receive trading, bidding and asking events.</p>
<p>Events happen in time, and it makes them timeseries data, which makes it a
perfect scenario to adopt hypertables.</p>
<p>The most granular data of trading events from market data is generally called tick.
Tick represents a single trade of something at a point in time. The tick
contains the necessary attributes of a deal in the financial markets.</p>
<p>The most simplified version of a tick is represented by:</p>
<ul>
<li>a <strong>time</strong> which the transaction happened.</li>
<li>a <strong>symbol</strong> which generally is the stock name.</li>
<li>a <strong>price</strong> representing the unit price of any stock.</li>
<li>a <strong>volume</strong> representing the amount of stocks being traded.</li>
</ul>
<p>Let's create the hypertable to store this information using the <code>create_table</code>
method from ActiveRecord API.</p>
<h2 id="create-the-hypertable">Create the hypertable<a class="headerlink" href="#create-the-hypertable" title="Permanent link">&para;</a></h2>
<p>We'll call <code>ticks</code> the hypertable name to store the market data.</p>
<p>The strategy will be the following:</p>
<ul>
<li>Partition the data into a week interval chunks. So, it means that every new week
a new partition depending on the <strong>time</strong> column.</li>
<li>Compress the data after a month to save storage.</li>
<li>Remove the raw data after six months and just leave the aggregated data for
longer time.</li>
</ul>
<p>Ticks are massive. They can reach milions of events per day. That's why it's
important to have a compression policy since day one. Compressing data is a key
timescaledb feature. It can be done automatically and every chunk can be
compressed after a desired period. Timescaledb has an excellent compression
ratio for market data and you can easily reach 95% savings on storage by
adopting compression.</p>
<p>The timescaledb gem adds the <code>hypertable</code> keyword to the <code>create_table</code> method,
which allows you to specify anything related to the hypertable.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span> <span class="k">do</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  <span class="n">hypertable_options</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="ss">time_column</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="ss">chunk_time_interval</span><span class="p">:</span> <span class="s1">&#39;1 week&#39;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="ss">compress_segmentby</span><span class="p">:</span> <span class="s1">&#39;symbol&#39;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="ss">compress_orderby</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="ss">compression_interval</span><span class="p">:</span> <span class="s1">&#39;1 month&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  <span class="p">}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  <span class="n">create_table</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="ss">hypertable</span><span class="p">:</span> <span class="n">hypertable_options</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span> <span class="ss">:time</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:symbol</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">t</span><span class="o">.</span><span class="n">decimal</span> <span class="ss">:price</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">t</span><span class="o">.</span><span class="n">decimal</span> <span class="ss">:volume</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>  <span class="k">end</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  <span class="n">add_index</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="o">[</span><span class="ss">:time</span><span class="p">,</span> <span class="ss">:symbol</span><span class="o">]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="k">end</span>
</code></pre></div>
<p>Note that the previous command is a standard <code>create_table</code> method call. The
timescaledb gem is just adding the <code>hypertable</code> keyword which allows to
configure everything in the same point.</p>
<p>In this case, we have the following commands being executed behind the scenes:</p>
<ol>
<li>Create the standard table</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;ticks&quot;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="ss">&quot;time&quot;</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="ss">&quot;symbol&quot;</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="ss">&quot;price&quot;</span><span class="w"> </span><span class="nb">decimal</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="ss">&quot;volume&quot;</span><span class="w"> </span><span class="nb">float</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Convert it to a hypertable with <code>chunk_time_interval</code> of <strong>1 week</strong>.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">create_hypertable</span><span class="p">(</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_time_interval</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 week&#39;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<ol>
<li>The compression is enabled and configured in the hypertable.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="n">timescaledb</span><span class="p">.</span><span class="n">compress</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="n">timescaledb</span><span class="p">.</span><span class="n">compress_orderby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="n">timescaledb</span><span class="p">.</span><span class="n">compress_segmentby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;symbol&#39;</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">)</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Index by time and symbol</li>
</ol>
<p>It will be high used the combination of time and symbol. It's good to have a
symbol. The <code>create_index</code> is the last call and it will make common queries run
faster.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="ss">&quot;index_ticks_on_time_and_symbol&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="ss">&quot;ticks&quot;</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;time&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;symbol&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Add the compression policy to compress data after a month</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">add_compression_policy</span><span class="p">(</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 month&#39;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<h2 id="create-the-orm-model">Create the ORM model<a class="headerlink" href="#create-the-orm-model" title="Permanent link">&para;</a></h2>
<p>To define the model, we're going to inherit <code>ActiveRecord::Base</code>
to create a model.</p>
<p>Timeseries data will always require the time column and the primary key can be
discarded. A few default methods will not work if they depend on the if of the
object.</p>
<p>The model is the best place to describe how you'll be using the timescaledb to
keep your model DRY and consistent.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>  <span class="n">acts_as_hypertable</span> <span class="ss">time_column</span><span class="p">:</span> <span class="ss">:time</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  <span class="n">acts_as_time_vector</span> <span class="ss">value_column</span><span class="p">:</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">segment_by</span><span class="p">:</span> <span class="ss">:symbol</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">end</span>
</code></pre></div>
<p>Actually, the gem shares how the </p>
<p>The <code>acts_as_hypertable</code> macro will assume the actual model corresponds to a
hypertable and inject useful scopes and methods that can be wrapping to the
following TimescaleDB features:</p>
<ul>
<li>
<p><code>.hypertable</code> will give you access to the [hypertable][hypertable] domain,
  the <code>table_name</code> will be used to get all metadata from the
  <code>_timescaledb_catalog</code> and combine all the functions that receives a 
  hypertable_name as a parameter.</p>
</li>
<li>
<p>The <code>time_column</code> keyword argument will be used to build scopes like
  <code>.yesterday</code>, <code>.previous_week</code>, <code>.last_hour</code>. And can be used for your own
  scopes using the <code>time_column</code> metadata.</p>
</li>
</ul>
<p>The <code>acts_as_time_vector</code> will be offering functions related to timescaledb
toolkit.</p>
<p>The <code>value_column:</code> will be combined with the <code>time_column</code> from the hypertable
to use scopes like  <code>candlestick</code>, <code>volatility</code>, <code>lttb</code> and just configure the
missing information.</p>
<p>The <code>segment_by:</code> will be widely used in the scopes to group by the data.</p>
<p>When the keywords <code>time_column</code>, <code>value_column</code> and <code>segment_by</code> are used in the
<code>acts_as_{hypertable,time_vector}</code> modules.</p>
<p>By convention, all scopes reuse the metadata from the configuration. It can facilitate
the process of build a lot of hypertable abstractions to facilitate the use combined scopes in the queries.</p>
<h3 id="the-acts_as_hypertable-macro">The <code>acts_as_hypertable</code> macro<a class="headerlink" href="#the-acts_as_hypertable-macro" title="Permanent link">&para;</a></h3>
<p>The <code>acts_as_hypertable</code> will bring the <code>Model.hypertable</code> which will allow us
to use a set of timeseries related set what are the default columns used to
calculate the data.</p>
<h3 id="the-acts_as_time_vector-macro">The <code>acts_as_time_vector</code> macro<a class="headerlink" href="#the-acts_as_time_vector-macro" title="Permanent link">&para;</a></h3>
<p>The <code>acts_as_time_vector</code> will allow us to set what are the default columns used
to calculate the data.</p>
<p>The <code>acts_as_time_vector</code> will inject handy scopes that wraps the
default formulas from timescaledb-toolkit extension.</p>
<p>It will be very powerful to build your set of abstractions over it and simplify
the maintenance of complex queries directly in the database.</p>
<h2 id="inserting-data">Inserting data<a class="headerlink" href="#inserting-data" title="Permanent link">&para;</a></h2>
<p>The <code>generate_series</code> sql function can speed up the process to seed some random
data and make it available to start playing with the queries.</p>
<p>The following code will insert tick data simulating prices from the previews
week until yesterday. We're using a single symbol and one tick every 10 seconds.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span> <span class="k">do</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>  <span class="n">data_range</span> <span class="o">=</span> <span class="p">{</span><span class="ss">from</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">to_date</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">to_date</span><span class="p">}</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>  <span class="n">execute</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">sanitize_sql_for_conditions</span><span class="p">(</span> <span class="o">[&lt;&lt;~</span><span class="dl">SQL</span><span class="p">,</span> <span class="n">data_range</span><span class="o">]</span><span class="p">))</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="sh">    INSERT INTO ticks</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="sh">    SELECT time, &#39;SYMBOL&#39;, 1 + (random()*30)::int, 100*(random()*10)::int</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="sh">    FROM generate_series(</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="sh">      TIMESTAMP :from,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="sh">      TIMESTAMP :to,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="sh">      INTERVAL &#39;10 second&#39;) AS time;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="dl">    SQL</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="k">end</span>
</code></pre></div>
<p>The database will seed a week of trade data with a randomize prices and volumes
simulating one event every 10 seconds.</p>
<p>The candlestick will split the timeframe by the <code>time_column</code> and use the <code>price</code>
as the default value to process the candlestick. It will also segment the
candles by the <code>symbol</code>. Symbol can be any stock trade and it's good to be
segmenting and indexing by it.</p>
<p>If you need to generate some data for your table, please check <a href="https://ideia.me/timescale-continuous-aggregates-with-ruby">this post</a>.</p>
<h2 id="query-data">Query data<a class="headerlink" href="#query-data" title="Permanent link">&para;</a></h2>
<p>When the <code>acts_as_time_vector</code> method is used in the model, it will inject
several scopes from the toolkit to easily have access to functions like the
<code>_candlestick</code>.</p>
<p>The <code>candlestick</code> scope is available with a few parameters that inherits the
configuration from the <code>acts_as_time_vector</code> declared previously.</p>
<p>The simplest query is:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="no">Tick</span><span class="o">.</span><span class="n">candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1m&#39;</span><span class="p">)</span>
</code></pre></div>
<p>It will generate the following SQL:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="ss">&quot;time&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">time</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">      </span><span class="ss">&quot;ticks&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">      </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">candlestick</span><span class="p">(</span><span class="k">time</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">volume</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;ticks&quot;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="k">AS</span><span class="w"> </span><span class="n">candlestick</span><span class="w"></span>
</code></pre></div>
<p>The timeframe argument can also be skipped and the default is <code>1 hour</code>.</p>
<p>You can also combine other scopes to filter data before you get the data from
the candlestick:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="no">Tick</span><span class="o">.</span><span class="n">yesterday</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">symbol</span><span class="p">:</span> <span class="s2">&quot;APPL&quot;</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>  <span class="o">.</span><span class="n">candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1m&#39;</span><span class="p">)</span>
</code></pre></div>
<p>The <code>yesterday</code> scope is automatically included because of the <code>acts_as_hypertable</code> macro. And it will be combining with other where clauses.</p>
<h2 id="continuous-aggregates">Continuous aggregates<a class="headerlink" href="#continuous-aggregates" title="Permanent link">&para;</a></h2>
<p>If you would like to continuous process the stream and aggregate the candlesticks
on a materialized view you can use continuous aggregates for it.</p>
<p>The next examples shows how to create a continuous aggregates of 1 minute
candlesticks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span> <span class="k">do</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>  <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="ss">with_data</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="ss">refresh_policies</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>      <span class="ss">start_offset</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;1 month&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>      <span class="ss">end_offset</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;1 minute&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>      <span class="ss">schedule_interval</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;1 minute&#39;&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="p">}</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>  <span class="p">}</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1m&#39;</span><span class="p">,</span> <span class="no">Tick</span><span class="o">.</span><span class="n">_candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1m&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="k">end</span>
</code></pre></div>
<p>Note that the <code>create_continuous_aggregate</code> calls the <code>to_sql</code> method in case
the second parameter is not a string.</p>
<p>Also, we're using the <code>_candlestick</code> method scope instead of the <code>candlestick</code>
one.</p>
<p>The reason is that the <code>candlestick</code> method already bring the attribute values
while the <code>_candlestick</code> can bring you the pre-processed data in a intermediate
state that can be rolled up with other candlesticks. For example, let's say you
already created a continuous aggregates of one minute and now you'd like to
process 5 minutes. You don't need to reprocess the raw data. You can build the
candlestick using the information from the one minute candlesticks.</p>
<h2 id="models-for-views">Models for views<a class="headerlink" href="#models-for-views" title="Permanent link">&para;</a></h2>
<p>It's very convenient to setup models for continuous aggregates which can
make it easy to inherit all smart methods to compose queries.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">class</span> <span class="nc">Candlestick1m</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>  <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;candlestick_1m&#39;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>  <span class="kp">include</span> <span class="no">Candlestick</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">end</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">class</span> <span class="nc">Candlestick1h</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>  <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;candlestick_1h&#39;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>  <span class="kp">include</span> <span class="no">Candlestick</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="k">end</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="k">class</span> <span class="nc">Candlestick1d</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>  <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;candlestick_1d&#39;</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>  <span class="kp">include</span> <span class="no">Candlestick</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="k">end</span>
</code></pre></div>
<p>Note that all classes include the <code>Candlestick</code> module. Let's define it to make
it easy to use the shared behavior.</p>
<h3 id="the-candlestick-concern">The candlestick concern<a class="headerlink" href="#the-candlestick-concern" title="Permanent link">&para;</a></h3>
<p>Concerns are already available through active_support and they can help you to
organize shared logic that can be included in multiple models.</p>
<p>In this concern, we'll have:</p>
<ol>
<li>Use the <code>acts_as_hypertable</code> macro to inherit all query scopes.</li>
<li>Define attributes for all candlestick attributes</li>
<li>Define extra scopes to read the data and rollup to bigger timeframes.</li>
<li>Mark the model as readonly.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">require</span> <span class="s2">&quot;active_support/concern&quot;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">module</span> <span class="nn">Candlestick</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>  <span class="n">included</span> <span class="k">do</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">acts_as_hypertable</span> <span class="ss">time_column</span><span class="p">:</span> <span class="s2">&quot;time_bucket&quot;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="sx">%w[open high low close]</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>      <span class="n">attribute</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">:decimal</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>      <span class="n">attribute</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_time&quot;</span><span class="p">,</span> <span class="ss">:time</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="k">end</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="n">attribute</span> <span class="ss">:volume</span><span class="p">,</span> <span class="ss">:decimal</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    <span class="n">attribute</span> <span class="ss">:vwap</span><span class="p">,</span> <span class="ss">:decimal</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    <span class="n">scope</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">do</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>      <span class="nb">select</span><span class="p">(</span><span class="s2">&quot;symbol, time_bucket,</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="s2">        toolkit_experimental.open(candlestick),</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="s2">        toolkit_experimental.high(candlestick),</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="s2">        toolkit_experimental.low(candlestick),</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="s2">        toolkit_experimental.close(candlestick),</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="s2">        toolkit_experimental.open_time(candlestick),</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="s2">        toolkit_experimental.high_time(candlestick),</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="s2">        toolkit_experimental.low_time(candlestick),</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="s2">        toolkit_experimental.close_time(candlestick),</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="s2">        toolkit_experimental.volume(candlestick),</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="s2">        toolkit_experimental.vwap(candlestick)&quot;</span><span class="p">)</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>    <span class="k">end</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="k">def</span> <span class="nf">readonly?</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>      <span class="kp">true</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>    <span class="k">end</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>  <span class="k">end</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="k">end</span>
</code></pre></div>
<h2 id="hierarchical-continuous-aggregates">Hierarchical continuous aggregates<a class="headerlink" href="#hierarchical-continuous-aggregates" title="Permanent link">&para;</a></h2>
<p>After you get the first one minute continuous aggregates, you don't need to
revisit the raw data to create candlesticks from it. You can build the 1 hour
candlestick from the 1 minute candlestick. The <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/hierarchical-continuous-aggregates/">Hierarchical continuous aggregates</a>
are very useful to save IO and processing time.</p>
<h3 id="rollup">Rollup<a class="headerlink" href="#rollup" title="Permanent link">&para;</a></h3>
<p>The <a href="https://docs.timescale.com/api/latest/hyperfunctions/financial-analysis/candlestick_agg/">candlestick_agg</a> function returns a <code>candlesticksummary</code> object.</p>
<p>The rollup allows you to combine candlestick summaries into new structures from
smaller timeframes to bigger timeframes without needing to reprocess all the data.</p>
<p>With this feature, you can group by the candlesticks multiple times saving processing 
from the server and make it easier to manage aggregations with different time intervals.</p>
<p>In the previous example, we used the <code>.candlestick</code> function that returns already the
attributes from the different timeframes. In the SQL command it's calling the
<code>open</code>, <code>high</code>, <code>low</code>, <code>close</code>, <code>volume</code>, and <code>vwap</code> functions that can access
the values behind the candlesticksummary type.</p>
<p>To merge the candlesticks, the rollup method can aggregate several <code>candlesticksummary</code>
objects into a bigger timeframe.</p>
<p>Let's rollup the structures:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">module</span> <span class="nn">Candlestick</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>  <span class="n">included</span> <span class="k">do</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="c1"># ... previous code remains the same</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">scope</span> <span class="ss">:rollup</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1h&#39;</span><span class="p">)</span> <span class="k">do</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>      <span class="n">bucket</span> <span class="o">=</span> <span class="sx">%|time_bucket(&#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="sx">&#39;, &quot;time_bucket&quot;)|</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>      <span class="nb">select</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>            <span class="s2">&quot;toolkit_experimental.rollup(candlestick) as candlestick&quot;</span><span class="p">)</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>      <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>      <span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">end</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>  <span class="k">end</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="k">end</span>
</code></pre></div>
<p>Now, the new views in bigger timeframes can be added using it's own objects.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span> <span class="k">do</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>  <span class="n">options</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">timeframe</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="p">{</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>      <span class="ss">with_data</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>      <span class="ss">refresh_policies</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="ss">start_offset</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;1 month&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="ss">end_offset</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="ss">schedule_interval</span><span class="p">:</span> <span class="s2">&quot;INTERVAL &#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>      <span class="p">}</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="p">}</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>  <span class="p">}</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1h&#39;</span><span class="p">,</span> <span class="no">Candlestick1m</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1 hour&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="o">[</span><span class="s1">&#39;1 hour&#39;</span><span class="o">]</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1d&#39;</span><span class="p">,</span> <span class="no">Candlestick1h</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1 day&#39;</span><span class="p">),</span>  <span class="o">**</span><span class="n">options</span><span class="o">[</span><span class="s1">&#39;1 day&#39;</span><span class="o">]</span><span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="k">end</span>
</code></pre></div>
<p>The final SQL executed to create the first <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/hierarchical-continuous-aggregates/">hierarchical continuous aggregates</a>
is the following:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">candlestick_1h</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span><span class="w"></span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="w"></span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">  </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="k">WITH</span><span class="w"> </span><span class="k">DATA</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>So, as you can see all candlestick of one hour views follows the same interface of
one minute, having the same column names and values, allowing to be reuse in
larger timeframes.</p>
<h3 id="refresh-policy">Refresh policy<a class="headerlink" href="#refresh-policy" title="Permanent link">&para;</a></h3>
<p>Timescaledb is assuming you're storing real time data. Which means you can
continuous feed the <code>ticks</code> table and aggregate the materialized data from time
to time.</p>
<p>When <code>create_continuous_aggregate</code> is called with a <code>schedule_interval</code> it will
also execute the following SQL line:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">add_continuous_aggregate_policy</span><span class="p">(</span><span class="s1">&#39;candlestick_1h&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span><span class="n">start_offset</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 month&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="n">end_offset</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span><span class="n">schedule_interval</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Instead of updating the values row by row, the refresh policy will automatically
run in background and aggregate the new data with the configured timeframe.</p>
<h2 id="querying-continuous-aggregates-with-custom-activerecord-models">Querying Continuous Aggregates with custom ActiveRecord models<a class="headerlink" href="#querying-continuous-aggregates-with-custom-activerecord-models" title="Permanent link">&para;</a></h2>
<p>With the <code>Candlestick1m</code> and <code>Candlestick1h</code> wrapping the continuous aggregates
into models, now, it's time to explore the available scopes and what to do with
it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">first</span>
</code></pre></div>
<p>It will run the following SQL:
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="o">*</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2023-01-23&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</code></pre></div></p>
<p>And return the following object:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">#&lt;Candlestick1m:0x000000010fbeff68</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a> <span class="ss">time_bucket</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a> <span class="ss">symbol</span><span class="p">:</span> <span class="s2">&quot;SYMBOL&quot;</span><span class="p">,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a> <span class="ss">candlestick</span><span class="p">:</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>  <span class="s2">&quot;(version:1,open:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:00+00</span><span class="se">\&quot;</span><span class="s2">,val:9),high:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:10+00</span><span class="se">\&quot;</span><span class="s2">,val:24),low:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\&quot;</span><span class="s2">,val:2),close:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\&quot;</span><span class="s2">,val:2),volume:Transaction(vol:2400,vwap:26200))&quot;</span><span class="p">,</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a> <span class="nb">open</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a> <span class="ss">open_time</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a> <span class="ss">high</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a> <span class="ss">high_time</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a> <span class="ss">low</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a> <span class="ss">low_time</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a> <span class="ss">close</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a> <span class="ss">close_time</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a> <span class="ss">volume</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a> <span class="ss">vwap</span><span class="p">:</span> <span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div>
<p>Note that the attributes are not available in the object but a <code>candlestick</code>
attribute is present holding all the information. That's why it's necessary to
use the <code>attributes</code> scope:
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">first</span>
</code></pre></div></p>
<p>Which will run the following query:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="w"></span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2023-01-23&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</code></pre></div></p>
<p>And the object will be filled with the attributes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="o">=&gt;</span> <span class="c1">#&lt;Candlestick1m:0x000000010fc3e578</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a> <span class="ss">time_bucket</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a> <span class="ss">symbol</span><span class="p">:</span> <span class="s2">&quot;SYMBOL&quot;</span><span class="p">,</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a> <span class="nb">open</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">9</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a> <span class="ss">open_time</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a> <span class="ss">high</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">24</span><span class="n">e2</span><span class="p">,</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a> <span class="ss">high_time</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">10</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a> <span class="ss">low</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a> <span class="ss">low_time</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a> <span class="ss">close</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a> <span class="ss">close_time</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a> <span class="ss">volume</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">24</span><span class="n">e4</span><span class="p">,</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a> <span class="ss">vwap</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1091666666666666</span><span class="n">e2</span><span class="o">&gt;</span>
</code></pre></div>
<p>It's a very convenient strategy to have the <code>Candlestick</code> as a shared concern
to allow to reuse queries in different views of the same type.</p>
<p>The <code>rollup</code> scope is the one that was used to redefine the data into big timeframes
and the <code>attributes</code> allow to access the attributes from the candlestick type.</p>
<p>In this way, the views become just shortcuts and complex sql can also be done
just nesting the model scope. For example, to rollup from a minute to one hour,
you can do:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">from</span><span class="p">(</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>  <span class="no">Candlestick1m</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1 hour&#39;</span><span class="p">)</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="p">)</span>
</code></pre></div>
<p>And from minute to one hour to a day:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">from</span><span class="p">(</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>  <span class="no">Candlestick1m</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1 day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">from</span><span class="p">(</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="no">Candlestick1m</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span> <span class="s1">&#39;1 hour&#39;</span><span class="p">)</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>  <span class="p">)</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">)</span>
</code></pre></div>
<p>Both examples are just using the one minute continuous aggregates view and
reprocessing it from there.</p>
<p>Composing the subqueries will probably be less efficient and unnecessary as we
already created more continuous aggregates in the top of another continuous
aggregates. Here is the SQL generated from the last nested rollups code:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">  </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">    </span><span class="n">symbol</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">    </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span><span class="w"></span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">      </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">      </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span><span class="w"></span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">subquery</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="p">)</span><span class="w"> </span><span class="n">subquery</span><span class="w"></span>
</code></pre></div>
<h2 id="plotting-data">Plotting data<a class="headerlink" href="#plotting-data" title="Permanent link">&para;</a></h2>
<p>Now, the final step is plot the data using the javascript <code>plotly</code> library.</p>
<p>For this step, we're going to use a sinatra library to serve HTML and javascript
and build the endpoints that will be consumed by the front end.</p>
<h3 id="the-sinatra-app">The Sinatra App<a class="headerlink" href="#the-sinatra-app" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>require &#39;sinatra/base&#39;
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>require &quot;sinatra/json&quot;
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>class App <span class="p">&lt;</span> <span class="nt">Sinatra::Base</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>  <span class="na">get</span> <span class="err">&#39;/</span><span class="na">candlestick</span><span class="err">.</span><span class="na">js</span><span class="err">&#39;</span> <span class="na">do</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="na">send_file</span> <span class="err">&#39;</span><span class="na">candlestick</span><span class="err">.</span><span class="na">js</span><span class="err">&#39;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>  <span class="na">end</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>  <span class="na">get</span> <span class="err">&#39;/</span><span class="na">candlestick_1m</span><span class="err">&#39;</span> <span class="na">do</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="na">json</span><span class="err">({</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>      <span class="na">title:</span> <span class="err">&quot;</span><span class="na">Candlestick</span> <span class="na">1</span> <span class="na">minute</span> <span class="na">last</span> <span class="na">hour</span><span class="err">&quot;,</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>      <span class="na">data:</span> <span class="na">Candlestick1m</span><span class="err">.</span><span class="na">last_hour</span><span class="err">.</span><span class="na">plotly_candlestick</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>    <span class="err">})</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>  <span class="na">end</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>  <span class="na">get</span> <span class="err">&#39;/</span><span class="na">candlestick_1h</span><span class="err">&#39;</span> <span class="na">do</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>    <span class="na">json</span><span class="err">({</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>      <span class="na">title:</span> <span class="err">&quot;</span><span class="na">Candlestick</span> <span class="na">yesterday</span> <span class="na">hourly</span><span class="err">&quot;,</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>      <span class="na">data:</span> <span class="na">Candlestick1h</span><span class="err">.</span><span class="na">yesterday</span><span class="err">.</span><span class="na">plotly_candlestick</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>    <span class="err">})</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>  <span class="na">end</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>  <span class="na">get</span> <span class="err">&#39;/</span><span class="na">candlestick_1d</span><span class="err">&#39;</span> <span class="na">do</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>    <span class="na">json</span><span class="err">({</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>      <span class="na">title:</span> <span class="err">&quot;</span><span class="na">Candlestick</span> <span class="na">daily</span> <span class="na">this</span> <span class="na">month</span><span class="err">&quot;,</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>      <span class="na">data:</span> <span class="na">Candlestick1d</span><span class="err">.</span><span class="na">previous_week</span><span class="err">.</span><span class="na">plotly_candlestick</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>    <span class="err">})</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>  <span class="na">end</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>  <span class="na">get</span> <span class="err">&#39;/&#39;</span> <span class="na">do</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="err">&lt;&lt;</span><span class="na">-HTML</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>  <span class="err">&lt;</span><span class="na">head</span><span class="p">&gt;</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#39;https://cdn.plot.ly/plotly-2.17.1.min.js&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#39;/candlestick.js&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;charts&#39;</span><span class="p">&gt;</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>HTML
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>  end
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>  run! if app_file == $0
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>end
</code></pre></div>
<h3 id="plotting-data-with-javascript">Plotting data with Javascript<a class="headerlink" href="#plotting-data-with-javascript" title="Permanent link">&para;</a></h3>
<p>And the <code>candlesticks.js</code> file will be responsible for fetch data async and
add new candlestick charts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kd">let</span><span class="w"> </span><span class="nx">addChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;#charts&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"></span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kd">function</span><span class="w"> </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="w"></span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">open</span><span class="p">,</span><span class="w"> </span><span class="nx">high</span><span class="p">,</span><span class="w"> </span><span class="nx">low</span><span class="p">,</span><span class="w"> </span><span class="nx">close</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">      </span><span class="nx">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">open</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">      </span><span class="nx">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">high</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">      </span><span class="nx">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">low</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">      </span><span class="nx">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">close</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">        </span><span class="nx">dragmode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">        </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">40</span><span class="p">,</span><span class="w"> </span><span class="nx">l</span><span class="o">:</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">        </span><span class="nx">showlegend</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">        </span><span class="nx">xaxis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">          </span><span class="nx">autorange</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">          </span><span class="nx">domain</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;date&#39;</span><span class="w"></span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">        </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="nx">yaxis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">          </span><span class="nx">autorange</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">          </span><span class="nx">domain</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;linear&#39;</span><span class="w"></span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">      </span><span class="nx">ohlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">open</span><span class="p">,</span><span class="w"> </span><span class="nx">high</span><span class="p">,</span><span class="w"> </span><span class="nx">low</span><span class="p">,</span><span class="w"> </span><span class="nx">close</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">      </span><span class="nx">Plotly</span><span class="p">.</span><span class="nx">newPlot</span><span class="p">(</span><span class="nx">addChart</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="nx">ohlc</span><span class="p">],</span><span class="w"> </span><span class="nx">layout</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">  </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="nx">$</span><span class="p">(</span><span class="w"> </span><span class="nb">document</span><span class="w"> </span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1m&#39;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1h&#39;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1d&#39;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>Note that a new <code>plotly_candlestick</code> scope was mentioned in the view models and
we need to add it to the <code>Candlestick</code> module to make it available for all the
charts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">module</span> <span class="nn">Candlestick</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  <span class="n">included</span> <span class="k">do</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="c1"># ... previous code remains the same</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="n">scope</span> <span class="ss">:plotly_candlestick</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">do</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>      <span class="n">data</span> <span class="o">=</span> <span class="n">attributes</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>      <span class="p">{</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>        <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;candlestick&#39;</span><span class="p">,</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>        <span class="ss">xaxis</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>        <span class="ss">yaxis</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>        <span class="ss">x</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:time_bucket</span><span class="p">),</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>        <span class="nb">open</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:open</span><span class="p">),</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>        <span class="ss">high</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:high</span><span class="p">),</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>        <span class="ss">low</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:low</span><span class="p">),</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>        <span class="ss">close</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:close</span><span class="p">)</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>      <span class="p">}</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>    <span class="k">end</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>  <span class="k">end</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="k">end</span>
</code></pre></div>
<h2 id="formatting-time-vectors">Formatting time vectors<a class="headerlink" href="#formatting-time-vectors" title="Permanent link">&para;</a></h2>
<p>Another function from toolkit that can help you to prepare the data to plot is
the <code>to_text</code> one from the toolkit. This is an experimental feature that allows
you to prepare the JSON output using a template directly in the database to easily
dump the output data without need to convert the data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">module</span> <span class="nn">Candlestick</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  <span class="n">included</span> <span class="k">do</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="c1"># ... previous code remains the same</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="n">scope</span> <span class="ss">:time_vector_from_candlestick</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="ss">attribute</span><span class="p">:</span> <span class="s2">&quot;close&quot;</span><span class="p">)</span> <span class="k">do</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>      <span class="nb">select</span><span class="p">(</span><span class="s2">&quot;timevector(time_bucket, toolkit_experimental.</span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">(candlestick))&quot;</span><span class="p">)</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="k">end</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>    <span class="n">scope</span> <span class="ss">:plotly_attribute</span><span class="p">,</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>      <span class="o">-&gt;</span> <span class="p">(</span><span class="ss">attribute</span><span class="p">:</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>          <span class="ss">from</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>          <span class="ss">template</span><span class="p">:</span> <span class="sx">%\&#39;{&quot;x&quot;: {{ TIMES | json_encode() | safe }}, &quot;y&quot;: {{ VALUES | json_encode() | safe }}, &quot;type&quot;: &quot;scatter&quot;}&#39;\</span><span class="p">)</span> <span class="k">do</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>      <span class="n">from</span> <span class="o">||=</span> <span class="n">time_vector_from_candlestick</span><span class="p">(</span><span class="ss">attribute</span><span class="p">:</span> <span class="n">attribute</span><span class="p">)</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>      <span class="nb">select</span><span class="p">(</span><span class="s2">&quot;toolkit_experimental.to_text(tv.timevector, </span><span class="si">#{</span><span class="n">template</span><span class="si">}</span><span class="s2">)::json&quot;</span><span class="p">)</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>        <span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="s2">&quot;( </span><span class="si">#{</span><span class="n">from</span><span class="o">.</span><span class="n">to_sql</span><span class="si">}</span><span class="s2"> ) as tv&quot;</span><span class="p">)</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>        <span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="s2">&quot;to_text&quot;</span><span class="o">]</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>    <span class="k">end</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>  <span class="k">end</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="k">end</span>
</code></pre></div>
<p>The final SQL will look something like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">to_text</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="n">tv</span><span class="p">.</span><span class="n">timevector</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">    </span><span class="s1">&#39;{&quot;x&quot;: {{ TIMES | json_encode() | safe }}, &quot;y&quot;: {{ VALUES | json_encode() | safe }}, &quot;type&quot;: &quot;scatter&quot;}&#39;</span><span class="w"></span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">  </span><span class="p">)::</span><span class="n">json</span><span class="w"></span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">timevector</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">,</span><span class="w"> </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1h&quot;</span><span class="w"></span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</code></pre></div>
<p>Time vectors are the common ground for dataframe processing in the toolkit and
it will allow you to easily run into several analysis and export the info with
the <code>to_text</code> function.</p>
<p>The <code>to_text</code> function receives the second argument as a template:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="w">    </span><span class="s1">&#39;{&quot;x&quot;: {{ TIMES | json_encode() | safe }},</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="s1">      &quot;y&quot;: {{ VALUES | json_encode() | safe }},</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="s1">      &quot;type&quot;: &quot;scatter&quot;}&#39;</span><span class="w"></span>
</code></pre></div>
<p>As you can see the double curly braces can wrap variables and nested methods
which can help you to export the information with some string traits. By default
we have the following variables available:</p>
<ul>
<li><code>TIMES</code> refer to the vector of times</li>
<li><code>VALUES</code> refer to the vector of values</li>
<li><code>TIMEVALS</code> refer to the combination of pairs of times and values.</li>
</ul>
<h2 id="feedback-or-questions">Feedback or questions?<a class="headerlink" href="#feedback-or-questions" title="Permanent link">&para;</a></h2>
<p>I hope you find this tutorial interesting and you can also check the
<code>candlestick.rb</code> file in the <a href="https://github.com/jonatas/timescaledb/tree/master/examples/toolkit-demo">examples/toolkit-demo</a> folder.</p>
<p>If you have any questions or concerns, feel free to reach me (<a href="https://twitter.com/jonatasdp">@jonatasdp</a>) in the <a href="https://timescale.com/community">Timescale community</a> or tag timescaledb in your StackOverflow issue.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../toolkit_lttb_zoom/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Zooming with High Resolution" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Zooming with High Resolution
            </div>
          </div>
        </a>
      
      
        
        <a href="../command_line/" class="md-footer__link md-footer__link--next" aria-label="Next: Command Line" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Command Line
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
    
  </body>
</html>