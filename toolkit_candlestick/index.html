
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../toolkit_lttb_zoom/">
      
      
        <link rel="next" href="../command_line/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Toolkit Candlesticks tutorial - The Timescaledb gem</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-9B2BMB0TNQ"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-9B2BMB0TNQ",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-9B2BMB0TNQ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#setting-up-the-environment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The Timescaledb gem" class="md-header__button md-logo" aria-label="The Timescaledb gem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Timescaledb gem
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Toolkit Candlesticks tutorial
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/timescale/timescaledb-ruby" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The Timescaledb gem" class="md-nav__button md-logo" aria-label="The Timescaledb gem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The Timescaledb gem
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/timescale/timescaledb-ruby" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../migrations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenic_views/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenic Views
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Models
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../toolkit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Toolkit Integration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../toolkit_lttb_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Toolkit LTTB Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat_gpt_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open AI Long Term Storage Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../toolkit_lttb_zoom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zooming with High Resolution
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Toolkit Candlesticks tutorial
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Toolkit Candlesticks tutorial
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-hypertable" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the hypertable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-orm-model" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the ORM model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating the ORM model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-acts_as_hypertable-macro" class="md-nav__link">
    <span class="md-ellipsis">
      The acts_as_hypertable macro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-continuous_aggregates-macro" class="md-nav__link">
    <span class="md-ellipsis">
      The continuous_aggregates macro
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inserting-data" class="md-nav__link">
    <span class="md-ellipsis">
      Inserting data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-data" class="md-nav__link">
    <span class="md-ellipsis">
      Query data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      Continuous aggregates
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models-for-views" class="md-nav__link">
    <span class="md-ellipsis">
      Models for views
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical-continuous-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      Hierarchical continuous aggregates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hierarchical continuous aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollup" class="md-nav__link">
    <span class="md-ellipsis">
      Rollup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-continuous-aggregates-with-custom-activerecord-models" class="md-nav__link">
    <span class="md-ellipsis">
      Querying Continuous Aggregates with custom ActiveRecord models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plotting-data" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plotting data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-sinatra-app" class="md-nav__link">
    <span class="md-ellipsis">
      The Sinatra App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-data-with-javascript" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting data with Javascript
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-time-vectors" class="md-nav__link">
    <span class="md-ellipsis">
      Formatting time vectors
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../command_line/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../videos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Videos
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-hypertable" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the hypertable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-orm-model" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the ORM model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating the ORM model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-acts_as_hypertable-macro" class="md-nav__link">
    <span class="md-ellipsis">
      The acts_as_hypertable macro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-continuous_aggregates-macro" class="md-nav__link">
    <span class="md-ellipsis">
      The continuous_aggregates macro
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inserting-data" class="md-nav__link">
    <span class="md-ellipsis">
      Inserting data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-data" class="md-nav__link">
    <span class="md-ellipsis">
      Query data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#continuous-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      Continuous aggregates
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models-for-views" class="md-nav__link">
    <span class="md-ellipsis">
      Models for views
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical-continuous-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      Hierarchical continuous aggregates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hierarchical continuous aggregates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollup" class="md-nav__link">
    <span class="md-ellipsis">
      Rollup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-continuous-aggregates-with-custom-activerecord-models" class="md-nav__link">
    <span class="md-ellipsis">
      Querying Continuous Aggregates with custom ActiveRecord models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plotting-data" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plotting data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-sinatra-app" class="md-nav__link">
    <span class="md-ellipsis">
      The Sinatra App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-data-with-javascript" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting data with Javascript
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-time-vectors" class="md-nav__link">
    <span class="md-ellipsis">
      Formatting time vectors
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Toolkit Candlesticks tutorial</h1>

<p># Candlesticks</p>
<p>Candlesticks are a popular tool in technical analysis, used by traders to determine potential market movements. The [toolkit][toolkit] allows you to compute candlesticks with the [candlestick][candlestick] function.</p>
<p>Let's start by defining a table that stores trades from financial market data, and then we can calculate the candlesticks with the Timescaledb Toolkit.</p>
<h2 id="setting-up-the-environment">Setting up the environment<a class="headerlink" href="#setting-up-the-environment" title="Permanent link">&para;</a></h2>
<p>First, we'll set up our environment with the necessary gems:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;bundler/inline&#39;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">gemfile</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;timescaledb&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;../..&#39;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;pry&#39;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;puma&#39;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;sinatra&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;sinatra-contrib&#39;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="n">gem</span><span class="w"> </span><span class="s1">&#39;sinatra-reloader&#39;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="k">end</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span><span class="w"> </span><span class="no">ARGV</span><span class="o">.</span><span class="n">first</span>
</code></pre></div>
<h2 id="creating-the-hypertable">Creating the hypertable<a class="headerlink" href="#creating-the-hypertable" title="Permanent link">&para;</a></h2>
<p>We'll create a hypertable called <code>ticks</code> to store the market data:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">end</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">db</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span><span class="n">drop_table</span><span class="w"> </span><span class="ss">:ticks</span><span class="p">,</span><span class="w"> </span><span class="ss">if_exists</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span><span class="w"> </span><span class="ss">force</span><span class="p">:</span><span class="w"> </span><span class="ss">:cascade</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="n">hypertable_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="ss">time_column</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="ss">chunk_time_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 day&quot;</span><span class="p">,</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="ss">compress_segmentby</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="ss">compress_orderby</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="ss">compress_after</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 month&quot;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">  </span><span class="n">create_table</span><span class="w"> </span><span class="ss">:ticks</span><span class="p">,</span><span class="w"> </span><span class="ss">hypertable</span><span class="p">:</span><span class="w"> </span><span class="n">hypertable_options</span><span class="p">,</span><span class="w"> </span><span class="nb">id</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">t</span><span class="o">|</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="w"> </span><span class="ss">:time</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">    </span><span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="w"> </span><span class="ss">:symbol</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="n">t</span><span class="o">.</span><span class="n">decimal</span><span class="w"> </span><span class="ss">:price</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="n">t</span><span class="o">.</span><span class="n">decimal</span><span class="w"> </span><span class="ss">:volume</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">  </span><span class="n">add_index</span><span class="w"> </span><span class="ss">:ticks</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="ss">:time</span><span class="p">,</span><span class="w"> </span><span class="ss">:symbol</span><span class="o">]</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="k">end</span>
</code></pre></div>
<h2 id="creating-the-orm-model">Creating the ORM model<a class="headerlink" href="#creating-the-orm-model" title="Permanent link">&para;</a></h2>
<p>To define the model, we'll inherit <code>ActiveRecord::Base</code> to create a model. Timeseries data will always require the time column, and the primary key can be discarded. A few default methods will not work if they depend on the id of the object.</p>
<p>The model is the best place to describe how you'll be using the timescaledb to keep your model DRY and consistent.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="n">acts_as_hypertable</span><span class="w"> </span><span class="ss">time_column</span><span class="p">:</span><span class="w"> </span><span class="ss">:time</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="ss">segment_by</span><span class="p">:</span><span class="w"> </span><span class="ss">:symbol</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="ss">value_column</span><span class="p">:</span><span class="w"> </span><span class="ss">:price</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">   </span><span class="n">scope</span><span class="w"> </span><span class="ss">:ohlcv</span><span class="p">,</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nb">select</span><span class="p">(</span><span class="s2">&quot;symbol,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="s2">            first(price, time) as open,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="s2">            max(price) as high,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="s2">            min(price) as low,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="s2">            last(price, time) as close,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="s2">            sum(volume) as volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;symbol&quot;</span><span class="p">)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">  </span><span class="n">scope</span><span class="w"> </span><span class="ss">:plotly_candlestick</span><span class="p">,</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="ss">from</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">      </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;candlestick&#39;</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">      </span><span class="ss">xaxis</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">      </span><span class="ss">yaxis</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">      </span><span class="ss">x</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:time</span><span class="p">),</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">      </span><span class="nb">open</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:open</span><span class="p">),</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">      </span><span class="ss">high</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:high</span><span class="p">),</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">      </span><span class="ss">low</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:low</span><span class="p">),</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">      </span><span class="ss">close</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:close</span><span class="p">),</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">      </span><span class="ss">volume</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:volume</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">  </span><span class="n">continuous_aggregates</span><span class="p">(</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">    </span><span class="ss">timeframes</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="ss">:minute</span><span class="p">,</span><span class="w"> </span><span class="ss">:hour</span><span class="p">,</span><span class="w"> </span><span class="ss">:day</span><span class="p">,</span><span class="w"> </span><span class="ss">:month</span><span class="o">]</span><span class="p">,</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">    </span><span class="ss">scopes</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="ss">:ohlcv</span><span class="o">]</span><span class="p">,</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">    </span><span class="ss">refresh_policy</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">      </span><span class="ss">minute</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10 minutes&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 minute&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 minute&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">      </span><span class="ss">hour</span><span class="p">:</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4 hour&quot;</span><span class="p">,</span><span class="w">     </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 hour&quot;</span><span class="p">,</span><span class="w">   </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 hour&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">      </span><span class="ss">day</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3 day&quot;</span><span class="p">,</span><span class="w">      </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 day&quot;</span><span class="p">,</span><span class="w">    </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 day&quot;</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">      </span><span class="ss">month</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3 month&quot;</span><span class="p">,</span><span class="w">    </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 day&quot;</span><span class="p">,</span><span class="w">  </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1 day&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">  </span><span class="p">})</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">  </span><span class="n">descendants</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="n">e</span><span class="o">.</span><span class="n">time_vector_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_vector_options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">value_column</span><span class="p">:</span><span class="w"> </span><span class="ss">:close</span><span class="p">)}</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="k">end</span>
</code></pre></div>
<p>The <code>acts_as_hypertable</code> macro will assume the actual model corresponds to a hypertable and inject useful scopes and methods that can be wrapped to the following TimescaleDB features:</p>
<ul>
<li><code>.hypertable</code> will give you access to the [hypertable][hypertable] domain, the <code>table_name</code> will be used to get all metadata from the <code>_timescaledb_catalog</code> and combine all the functions that receives a hypertable_name as a parameter.</li>
<li>The <code>time_column</code> keyword argument will be used to build scopes like <code>.yesterday</code>, <code>.previous_week</code>, <code>.last_hour</code>. And can be used for your own scopes using the <code>time_column</code> metadata.</li>
</ul>
<p>The <code>value_column:</code> will be combined with the <code>time_column</code> from the hypertable to use scopes like <code>candlestick</code>, <code>volatility</code>, <code>lttb</code> and just configure the missing information.</p>
<p>The <code>segment_by:</code> will be widely used in the scopes to group by the data.</p>
<p>By convention, all scopes reuse the metadata from the configuration. It can facilitate the process of building a lot of hypertable abstractions to facilitate the use combined scopes in the queries.</p>
<h3 id="the-acts_as_hypertable-macro">The <code>acts_as_hypertable</code> macro<a class="headerlink" href="#the-acts_as_hypertable-macro" title="Permanent link">&para;</a></h3>
<p>The <code>acts_as_hypertable</code> will bring the <code>Model.hypertable</code> which will allow us to use a set of timeseries related set what are the default columns used to calculate the data.</p>
<h3 id="the-continuous_aggregates-macro">The <code>continuous_aggregates</code> macro<a class="headerlink" href="#the-continuous_aggregates-macro" title="Permanent link">&para;</a></h3>
<p>The <code>continuous_aggregates</code> macro will allow us to create continuous aggregates for the model. Generating a new materialized view for each scope + timeframe that will be continuously aggregated from the raw data.</p>
<p>The views will be rolling out from previous time frames, so it will be very efficient in terms of resource usage.</p>
<h2 id="inserting-data">Inserting data<a class="headerlink" href="#inserting-data" title="Permanent link">&para;</a></h2>
<p>The <code>generate_series</code> sql function can speed up the process to seed some random data and make it available to start playing with the queries.</p>
<p>The following code will insert tick data simulating prices from the previous week until yesterday. We're using a single symbol and one tick every 10 seconds.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="n">data_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="ss">from</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">to_date</span><span class="p">,</span><span class="w"> </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">to_date</span><span class="p">}</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="n">execute</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">sanitize_sql_for_conditions</span><span class="p">(</span><span class="w"> </span><span class="o">[&lt;&lt;~</span><span class="dl">SQL</span><span class="p">,</span><span class="w"> </span><span class="n">data_range</span><span class="o">]</span><span class="p">))</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sh">    INSERT INTO ticks</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="sh">    SELECT time, &#39;SYMBOL&#39;, 1 + (random()*30)::int, 100*(random()*10)::int</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sh">    FROM generate_series(</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="sh">      TIMESTAMP :from,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="sh">      TIMESTAMP :to,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="sh">      INTERVAL &#39;10 second&#39;) AS time;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="dl">    SQL</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">end</span>
</code></pre></div>
<p>The database will seed a week of trade data with a randomize prices and volumes simulating one event every 10 seconds.</p>
<p>The candlestick will split the timeframe by the <code>time_column</code> and use the <code>price</code> as the default value to process the candlestick. It will also segment the candles by the <code>symbol</code>. Symbol can be any stock trade and it's good to be segmenting and indexing by it.</p>
<p>If you need to generate some data for your table, please check [this post][2].</p>
<h2 id="query-data">Query data<a class="headerlink" href="#query-data" title="Permanent link">&para;</a></h2>
<p>When the <code>acts_as_hypertable</code> method is used in the model, it will inject several scopes from the toolkit to easily have access to functions like the <code>_candlestick</code>.</p>
<p>The <code>candlestick</code> scope is available with a few parameters that inherits the configuration from the <code>acts_as_hypertable</code> declared previously.</p>
<p>The simplest query is:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="no">Tick</span><span class="o">.</span><span class="n">candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">)</span>
</code></pre></div>
<p>It will generate the following SQL:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="ss">&quot;time&quot;</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">    </span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">time</span><span class="p">,</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">      </span><span class="ss">&quot;ticks&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">      </span><span class="n">candlestick_agg</span><span class="p">(</span><span class="k">time</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">volume</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;ticks&quot;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="k">AS</span><span class="w"> </span><span class="n">candlestick</span>
</code></pre></div>
<p>The timeframe argument can also be skipped and the default is <code>1 hour</code>.</p>
<p>You can also combine other scopes to filter data before you get the data from the candlestick:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="no">Tick</span><span class="o">.</span><span class="n">yesterday</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">symbol</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;APPL&quot;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="o">.</span><span class="n">candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">)</span>
</code></pre></div>
<p>The <code>yesterday</code> scope is automatically included because of the <code>acts_as_hypertable</code> macro. And it will be combining with other where clauses.</p>
<h2 id="continuous-aggregates">Continuous aggregates<a class="headerlink" href="#continuous-aggregates" title="Permanent link">&para;</a></h2>
<p>If you would like to create the continuous process one by one in the stream and aggregate the candlesticks on a materialized view you can use continuous aggregates for it.</p>
<p>The next examples shows how to create a single continuous aggregates of 1 minute candlesticks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="ss">with_data</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="ss">refresh_policies</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">      </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;1 month&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">      </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;1 minute&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">      </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;1 minute&#39;&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span><span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">Tick</span><span class="o">.</span><span class="n">_candlestick</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">),</span><span class="w"> </span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="k">end</span>
</code></pre></div>
<p>Note that the <code>create_continuous_aggregate</code> calls the <code>to_sql</code> method in case the second parameter is not a string.</p>
<p>Also, we're using the <code>_candlestick</code> method scope instead of the <code>candlestick</code> one.</p>
<p>The reason is that the <code>candlestick</code> method already bring the attribute values while the <code>_candlestick</code> can bring you the pre-processed data in a intermediate state that can be rolled up with other candlesticks. For example, let's say you already created a continuous aggregates of one minute and now you'd like to process 5 minutes. You don't need to reprocess the raw data. You can build the candlestick using the information from the one minute candlesticks.</p>
<h2 id="models-for-views">Models for views<a class="headerlink" href="#models-for-views" title="Permanent link">&para;</a></h2>
<p>The macro <code>continuous_aggregates</code> will create a new model for each continuous aggregate.</p>
<p>It's very convenient to setup models for continuous aggregates which can make it easy to inherit all smart methods to compose queries.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerMinute</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerHour</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerDay</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerMonth</span>
</code></pre></div>
<h2 id="hierarchical-continuous-aggregates">Hierarchical continuous aggregates<a class="headerlink" href="#hierarchical-continuous-aggregates" title="Permanent link">&para;</a></h2>
<p>After you get the first one minute continuous aggregates, you don't need to revisit the raw data to create candlesticks from it. You can build the 1 hour candlestick from the 1 minute candlestick. The [Hierarchical continuous aggregates][hcaggs] are very useful to save IO and processing time.</p>
<h3 id="rollup">Rollup<a class="headerlink" href="#rollup" title="Permanent link">&para;</a></h3>
<p>The [candlestick_agg][candlestick_agg] function returns a <code>candlesticksummary</code> object.</p>
<p>The rollup allows you to combine candlestick summaries into new structures from smaller timeframes to bigger timeframes without needing to reprocess all the data.</p>
<p>With this feature, you can group by the candlesticks multiple times saving processing from the server and make it easier to manage aggregations with different time intervals.</p>
<p>In the previous example, we used the <code>.candlestick</code> function that returns already the attributes from the different timeframes. In the SQL command it's calling the <code>open</code>, <code>high</code>, <code>low</code>, <code>close</code>, <code>volume</code>, and <code>vwap</code> functions that can access the values behind the candlesticksummary type.</p>
<p>To merge the candlesticks, the rollup method can aggregate several <code>candlesticksummary</code> objects into a bigger timeframe.</p>
<p>Let's rollup the structures:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">module</span><span class="w"> </span><span class="nn">Candlestick</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span><span class="kp">extend</span><span class="w"> </span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="n">included</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="c1"># ... rest of the code remains the same</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="n">scope</span><span class="w"> </span><span class="ss">:rollup</span><span class="p">,</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1h&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">      </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sx">%|time_bucket(&#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="sx">&#39;, &quot;time_bucket&quot;)|</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">      </span><span class="nb">select</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">            </span><span class="s2">&quot;rollup(candlestick) as candlestick&quot;</span><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">      </span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">      </span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="k">end</span>
</code></pre></div>
<p>Now, the new views in bigger timeframes can be added using it's own objects.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">instance_exec</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">      </span><span class="ss">with_data</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">      </span><span class="ss">refresh_policies</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="ss">start_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;1 month&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="ss">end_offset</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="ss">schedule_interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERVAL &#39;</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">  </span><span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1h&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">),</span><span class="w"> </span><span class="o">**</span><span class="n">options</span><span class="o">[</span><span class="s1">&#39;1 hour&#39;</span><span class="o">]</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">  </span><span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">&#39;candlestick_1d&#39;</span><span class="p">,</span><span class="w"> </span><span class="no">Candlestick1h</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="ss">timeframe</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1 day&#39;</span><span class="p">),</span><span class="w">  </span><span class="o">**</span><span class="n">options</span><span class="o">[</span><span class="s1">&#39;1 day&#39;</span><span class="o">]</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="k">end</span>
</code></pre></div>
<p>The final SQL executed to create the first [hierarchical continuous aggregates][hcaggs] is the following:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">MATERIALIZED</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">candlestick_1h</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">  </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="k">WITH</span><span class="w"> </span><span class="k">DATA</span><span class="p">;</span>
</code></pre></div>
<p>So, as you can see all candlestick of one hour views follows the same interface of one minute, having the same column names and values, allowing to be reuse in larger timeframes.</p>
<h3 id="refresh-policy">Refresh policy<a class="headerlink" href="#refresh-policy" title="Permanent link">&para;</a></h3>
<p>Timescaledb is assuming you're storing real time data. Which means you can continuous feed the <code>ticks</code> table and aggregate the materialized data from time to time.</p>
<p>When <code>create_continuous_aggregate</code> is called with a <code>schedule_interval</code> it will also execute the following SQL line:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">add_continuous_aggregate_policy</span><span class="p">(</span><span class="s1">&#39;candlestick_1h&#39;</span><span class="p">,</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="n">start_offset</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 month&#39;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="n">end_offset</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="n">schedule_interval</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Instead of updating the values row by row, the refresh policy will automatically run in background and aggregate the new data with the configured timeframe.</p>
<h2 id="querying-continuous-aggregates-with-custom-activerecord-models">Querying Continuous Aggregates with custom ActiveRecord models<a class="headerlink" href="#querying-continuous-aggregates-with-custom-activerecord-models" title="Permanent link">&para;</a></h2>
<p>With the <code>Candlestick1m</code> and <code>Candlestick1h</code> wrapping the continuous aggregates into models, now, it's time to explore the available scopes and what to do with it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">first</span>
</code></pre></div>
<p>It will run the following SQL:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="o">*</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2023-01-23&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></p>
<p>And return the following object:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">#&lt;Candlestick1m:0x000000010fbeff68</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w"> </span><span class="ss">time_bucket</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="w"> </span><span class="no">UTC</span><span class="p">,</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w"> </span><span class="ss">symbol</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SYMBOL&quot;</span><span class="p">,</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w"> </span><span class="ss">candlestick</span><span class="p">:</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">  </span><span class="s2">&quot;(version:1,open:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:00+00</span><span class="se">\&quot;</span><span class="s2">,val:9),high:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:10+00</span><span class="se">\&quot;</span><span class="s2">,val:24),low:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\&quot;</span><span class="s2">,val:2),close:(ts:</span><span class="se">\&quot;</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\&quot;</span><span class="s2">,val:2),volume:Transaction(vol:2400,vwap:26200))&quot;</span><span class="p">,</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w"> </span><span class="nb">open</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w"> </span><span class="ss">open_time</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w"> </span><span class="ss">high</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w"> </span><span class="ss">high_time</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w"> </span><span class="ss">low</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w"> </span><span class="ss">low_time</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w"> </span><span class="ss">close</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w"> </span><span class="ss">close_time</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w"> </span><span class="ss">volume</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w"> </span><span class="ss">vwap</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div>
<p>Note that the attributes are not available in the object but a <code>candlestick</code> attribute is present holding all the information. That's why it's necessary to use the <code>attributes</code> scope:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerMinute</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">first</span>
</code></pre></div></p>
<p>Which will run the following query:
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">,</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">  </span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">  </span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">  </span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">  </span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2023-01-23&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></p>
<p>And the object will be filled with the attributes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w"> </span><span class="ss">time_bucket</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="w"> </span><span class="no">UTC</span><span class="p">,</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w"> </span><span class="ss">symbol</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SYMBOL&quot;</span><span class="p">,</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w"> </span><span class="nb">open</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">9</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w"> </span><span class="ss">open_time</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="w"> </span><span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w"> </span><span class="ss">high</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">24</span><span class="n">e2</span><span class="p">,</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w"> </span><span class="ss">high_time</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w"> </span><span class="ss">low</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w"> </span><span class="ss">low_time</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w"> </span><span class="ss">close</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">e1</span><span class="p">,</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w"> </span><span class="ss">close_time</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span><span class="w"> </span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span><span class="w"> </span><span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w"> </span><span class="ss">volume</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">24</span><span class="n">e4</span><span class="p">,</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w"> </span><span class="ss">vwap</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">.</span><span class="mi">1091666666666666</span><span class="n">e2</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="p">}</span>
</code></pre></div>
<p>And from minute to one hour to a day:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="no">Tick</span><span class="o">::</span><span class="no">CandlestickPerMinute</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&quot;&#39;5 minutes&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Both examples are just using the one minute continuous aggregates view and reprocessing it from there.</p>
<p>Composing the subqueries will probably be less efficient and unnecessary as we already created more continuous aggregates in the top of another continuous aggregates. Here is the SQL generated from the last nested rollups code:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">,</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">  </span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">  </span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">  </span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="n">symbol</span><span class="p">,</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">time_bucket</span><span class="p">(</span><span class="s1">&#39;1 hour&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;time_bucket&quot;</span><span class="p">),</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">      </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="p">.</span><span class="ss">&quot;symbol&quot;</span><span class="p">,</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">      </span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">candlestick</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1m&quot;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">subquery</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="p">)</span><span class="w"> </span><span class="n">subquery</span>
</code></pre></div>
<h2 id="plotting-data">Plotting data<a class="headerlink" href="#plotting-data" title="Permanent link">&para;</a></h2>
<p>Now, the final step is plot the data using the javascript <code>plotly</code> library.</p>
<p>For this step, we're going to use a sinatra library to serve HTML and javascript and build the endpoints that will be consumed by the front end.</p>
<h3 id="the-sinatra-app">The Sinatra App<a class="headerlink" href="#the-sinatra-app" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">require</span><span class="w"> </span><span class="s1">&#39;sinatra/base&#39;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">require</span><span class="w"> </span><span class="s2">&quot;sinatra/json&quot;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="s1">&#39;/candlestick.js&#39;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="n">send_file</span><span class="w"> </span><span class="s1">&#39;candlestick.js&#39;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="s1">&#39;/candlestick_1m&#39;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="n">json</span><span class="p">({</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">      </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Candlestick 1 minute last hour&quot;</span><span class="p">,</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">      </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="no">Candlestick1m</span><span class="o">.</span><span class="n">last_hour</span><span class="o">.</span><span class="n">plotly_candlestick</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="s1">&#39;/candlestick_1h&#39;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="n">json</span><span class="p">({</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">      </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Candlestick yesterday hourly&quot;</span><span class="p">,</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">      </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="no">Candlestick1h</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">plotly_candlestick</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="s1">&#39;/candlestick_1d&#39;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">    </span><span class="n">json</span><span class="p">({</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">      </span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Candlestick daily this month&quot;</span><span class="p">,</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">      </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="no">Candlestick1d</span><span class="o">.</span><span class="n">previous_week</span><span class="o">.</span><span class="n">plotly_candlestick</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="w">  </span><span class="n">get</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="o">&lt;&lt;-</span><span class="dl">HTML</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="sh">  &lt;head&gt;</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="sh">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="sh">    &lt;script src=&#39;https://cdn.plot.ly/plotly-2.17.1.min.js&#39;&gt;&lt;/script&gt;</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="sh">    &lt;script src=&#39;/candlestick.js&#39;&gt;&lt;/script&gt;</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="sh">  &lt;/head&gt;</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="sh">  &lt;body&gt;</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="sh">    &lt;div id=&#39;charts&#39;&gt;</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="sh">  &lt;/body&gt;</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="dl">HTML</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="w">  </span><span class="n">run!</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">app_file</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="vg">$0</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a><span class="k">end</span>
</code></pre></div>
<h3 id="plotting-data-with-javascript">Plotting data with Javascript<a class="headerlink" href="#plotting-data-with-javascript" title="Permanent link">&para;</a></h3>
<p>And the <code>candlesticks.js</code> file will be responsible for fetch data async and add new candlestick charts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">let</span><span class="w"> </span><span class="nx">addChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;#charts&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kd">function</span><span class="w"> </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">open</span><span class="p">,</span><span class="w"> </span><span class="nx">high</span><span class="p">,</span><span class="w"> </span><span class="nx">low</span><span class="p">,</span><span class="w"> </span><span class="nx">close</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">      </span><span class="nx">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">open</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">      </span><span class="nx">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">high</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">      </span><span class="nx">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">low</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">      </span><span class="nx">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">close</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">);</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">        </span><span class="nx">dragmode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">        </span><span class="nx">margin</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="o">:</span><span class="w"> </span><span class="mf">25</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">40</span><span class="p">,</span><span class="w"> </span><span class="nx">l</span><span class="o">:</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="nx">showlegend</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="nx">xaxis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">          </span><span class="nx">autorange</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">          </span><span class="nx">domain</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">          </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;date&#39;</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">        </span><span class="nx">yaxis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">          </span><span class="nx">autorange</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">          </span><span class="nx">domain</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">],</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;linear&#39;</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">      </span><span class="p">};</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">      </span><span class="nx">ohlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">open</span><span class="p">,</span><span class="w"> </span><span class="nx">high</span><span class="p">,</span><span class="w"> </span><span class="nx">low</span><span class="p">,</span><span class="w"> </span><span class="nx">close</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">};</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="w">      </span><span class="nx">Plotly</span><span class="p">.</span><span class="nx">newPlot</span><span class="p">(</span><span class="nx">addChart</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="nx">ohlc</span><span class="p">],</span><span class="w"> </span><span class="nx">layout</span><span class="p">);</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="p">};</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="nx">$</span><span class="p">(</span><span class="w"> </span><span class="nb">document</span><span class="w"> </span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1m&#39;</span><span class="p">);</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1h&#39;</span><span class="p">);</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">  </span><span class="nx">ohlcChartFrom</span><span class="p">(</span><span class="s1">&#39;/candlestick_1d&#39;</span><span class="p">);</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="p">});</span>
</code></pre></div>
<p>Note that a new <code>plotly_candlestick</code> scope was mentioned in the view models and we need to add it to the <code>Candlestick</code> module to make it available for all the charts.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">module</span><span class="w"> </span><span class="nn">Candlestick</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="kp">extend</span><span class="w"> </span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">  </span><span class="n">included</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">    </span><span class="c1"># ... rest of the code remains the same</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="n">scope</span><span class="w"> </span><span class="ss">:plotly_candlestick</span><span class="p">,</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">      </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attributes</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">      </span><span class="p">{</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">        </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;candlestick&#39;</span><span class="p">,</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">        </span><span class="ss">xaxis</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">        </span><span class="ss">yaxis</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">        </span><span class="ss">x</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:time_bucket</span><span class="p">),</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">        </span><span class="nb">open</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:open</span><span class="p">),</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">        </span><span class="ss">high</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:high</span><span class="p">),</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">        </span><span class="ss">low</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:low</span><span class="p">),</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">        </span><span class="ss">close</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:close</span><span class="p">)</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="k">end</span>
</code></pre></div>
<h2 id="formatting-time-vectors">Formatting time vectors<a class="headerlink" href="#formatting-time-vectors" title="Permanent link">&para;</a></h2>
<p>Another function from toolkit that can help you to prepare the data to plot is the <code>to_text</code> one from the toolkit. This is an experimental feature that allows you to prepare the JSON output using a template directly in the database to easily dump the output data without need to convert the data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">module</span><span class="w"> </span><span class="nn">Candlestick</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="kp">extend</span><span class="w"> </span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="n">included</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="c1"># ... rest of the code remains the same</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="n">scope</span><span class="w"> </span><span class="ss">:time_vector_from_candlestick</span><span class="p">,</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="ss">attribute</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;close&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">      </span><span class="nb">select</span><span class="p">(</span><span class="s2">&quot;timevector(time_bucket, </span><span class="si">#{</span><span class="n">attribute</span><span class="si">}</span><span class="s2">(candlestick))&quot;</span><span class="p">)</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="n">scope</span><span class="w"> </span><span class="ss">:plotly_attribute</span><span class="p">,</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">      </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="ss">attribute</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;close&quot;</span><span class="p">,</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">          </span><span class="ss">from</span><span class="p">:</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">          </span><span class="ss">template</span><span class="p">:</span><span class="w"> </span><span class="sx">%\&#39;{&quot;x&quot;: {{ TIMES | json_encode() | safe }}, &quot;y&quot;: {{ VALUES | json_encode() | safe }}, &quot;type&quot;: &quot;scatter&quot;}&#39;\</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">      </span><span class="n">from</span><span class="w"> </span><span class="o">||=</span><span class="w"> </span><span class="n">time_vector_from_candlestick</span><span class="p">(</span><span class="ss">attribute</span><span class="p">:</span><span class="w"> </span><span class="n">attribute</span><span class="p">)</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">      </span><span class="nb">select</span><span class="p">(</span><span class="s2">&quot;toolkit_experimental.to_text(tv.timevector, </span><span class="si">#{</span><span class="n">template</span><span class="si">}</span><span class="s2">)::json&quot;</span><span class="p">)</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">        </span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="s2">&quot;( </span><span class="si">#{</span><span class="n">from</span><span class="o">.</span><span class="n">to_sql</span><span class="si">}</span><span class="s2"> ) as tv&quot;</span><span class="p">)</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">        </span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="s2">&quot;to_text&quot;</span><span class="o">]</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">    </span><span class="k">end</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">  </span><span class="k">end</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="k">end</span>
</code></pre></div>
<p>The final SQL will look something like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">to_text</span><span class="p">(</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="n">tv</span><span class="p">.</span><span class="n">timevector</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="s1">&#39;{&quot;x&quot;: {{ TIMES | json_encode() | safe }}, &quot;y&quot;: {{ VALUES | json_encode() | safe }}, &quot;type&quot;: &quot;scatter&quot;}&#39;</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">  </span><span class="p">)::</span><span class="n">json</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">timevector</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">,</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">))</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;candlestick_1h&quot;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>